{"version":3,"sources":["../../../../src/api/v1/usuarios/service.js"],"names":["getAllResources","offset","limit","search","resources","Resource","findAll","order","include","association","Perfil","attributes","as","where","ativo","Op","or","like","nome","email","sobrenome","username","sendEmail","novaSenha","transporter","nodemailer","createTransport","service","secure","port","auth","user","process","env","EMAIL_USER","pass","EMAIL_PASSWORD","tls","rejectUnauthorized","HelperOptions","from","to","subject","text","sendMail","error","info","console","log","getResource","id","resource","findByPk","getResourceEmail","findOne","createResource","create","updateResource","update","deleteResource","then","res","destroy","authenticate","password","Error","hash","get","compare","bcrypt","compareSync","payload","toJSON","jwt","sign","TOKEN_SECRET_KEY","expiresIn"],"mappings":";;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;;;AAEO,eAAeA,eAAf,CAA+BC,MAA/B,EAAuCC,KAAvC,EAA8CC,MAA9C,EAAsD;AAC3D,QAAMC,SAAS,GAAGC,eAASC,OAAT,CAAiB;AACjCC,IAAAA,KAAK,EAAE,CAAC,CAAC,IAAD,EAAO,MAAP,CAAD,CAD0B;AAEjCN,IAAAA,MAFiC;AAGjCC,IAAAA,KAHiC;AAIjCM,IAAAA,OAAO,EAAE,CACP;AACEC,MAAAA,WAAW,EAAEJ,eAASK,MADxB;AAEEC,MAAAA,UAAU,EAAE,CAAC,IAAD,EAAO,WAAP,CAFd;AAGEC,MAAAA,EAAE,EAAE;AAHN,KADO,CAJwB;AAWjCC,IAAAA,KAAK,EAAE;AACLC,MAAAA,KAAK,EAAE,CADF;AAEL,OAACC,cAAGC,EAAJ,GAAS,CACP;AACE,8BAAsB;AAAE,WAACD,cAAGE,IAAJ,GAAY,IAAGd,MAAO;AAAxB;AADxB,OADO,EAIP;AACEe,QAAAA,IAAI,EAAE;AAAE,WAACH,cAAGE,IAAJ,GAAY,IAAGd,MAAO;AAAxB;AADR,OAJO,EAOP;AACEgB,QAAAA,KAAK,EAAE;AAAE,WAACJ,cAAGE,IAAJ,GAAY,IAAGd,MAAO;AAAxB;AADT,OAPO,EAUP;AACEiB,QAAAA,SAAS,EAAE;AAAE,WAACL,cAAGE,IAAJ,GAAY,IAAGd,MAAO;AAAxB;AADb,OAVO,EAaP;AACEkB,QAAAA,QAAQ,EAAE;AAAE,WAACN,cAAGE,IAAJ,GAAY,IAAGd,MAAO;AAAxB;AADZ,OAbO;AAFJ;AAX0B,GAAjB,CAAlB;;AAiCA,SAAOC,SAAP;AACD;;AAEM,eAAekB,SAAf,CAAyBH,KAAzB,EAAgCI,SAAhC,EAA2C;AAChD,QAAMC,WAAW,GAAGC,oBAAWC,eAAX,CAA2B;AAC7CC,IAAAA,OAAO,EAAE,OADoC;AAC3B;AAClBC,IAAAA,MAAM,EAAE,KAFqC;AAE9B;AACfC,IAAAA,IAAI,EAAE,EAHuC;AAGnC;AACVC,IAAAA,IAAI,EAAE;AACJC,MAAAA,IAAI,EAAEC,OAAO,CAACC,GAAR,CAAYC,UADd;AAEJC,MAAAA,IAAI,EAAEH,OAAO,CAACC,GAAR,CAAYG;AAFd,KAJuC;AAQ7CC,IAAAA,GAAG,EAAE;AACHC,MAAAA,kBAAkB,EAAE;AADjB;AARwC,GAA3B,CAApB;;AAcA,QAAMC,aAAa,GAAG;AACpBC,IAAAA,IAAI,EAAE,uCADc;AAEpBC,IAAAA,EAAE,EAAEtB,KAFgB;AAGpBuB,IAAAA,OAAO,EAAE,YAHW;AAIpBC,IAAAA,IAAI,EAAG,4BAA2BpB,SAAU;AAJxB,GAAtB;AAQAC,EAAAA,WAAW,CAACoB,QAAZ,CAAqBL,aAArB,EAAoC,CAACM,KAAD,EAAQC,IAAR,KAAiB;AACnD,QAAID,KAAJ,EAAW;AACT,aAAOE,OAAO,CAACC,GAAR,CAAYH,KAAZ,CAAP;AACD;;AACDE,IAAAA,OAAO,CAACC,GAAR,CAAY,uBAAZ;AACAD,IAAAA,OAAO,CAACC,GAAR,CAAYF,IAAZ;AACD,GAND;AAOD;;AAEM,eAAeG,WAAf,CAA2BC,EAA3B,EAA+B;AACpC,QAAMC,QAAQ,GAAG,MAAM9C,eAAS+C,QAAT,CAAkBF,EAAlB,EAAsB;AAC3C1C,IAAAA,OAAO,EAAE,CACP;AACEC,MAAAA,WAAW,EAAEJ,eAASK,MADxB;AAEEC,MAAAA,UAAU,EAAE,CAAC,IAAD,EAAO,WAAP;AAFd,KADO;AADkC,GAAtB,CAAvB;AASA,SAAOwC,QAAP;AACD;;AAEM,eAAeE,gBAAf,CAAgClC,KAAhC,EAAuC;AAC5C,QAAMgC,QAAQ,GAAG,MAAM9C,eAASiD,OAAT,CAAiB;AACtC/C,IAAAA,KAAK,EAAE,CAAC,CAAC,IAAD,EAAO,MAAP,CAAD,CAD+B;AAEtCC,IAAAA,OAAO,EAAE,CACP;AACEC,MAAAA,WAAW,EAAEJ,eAASK,MADxB;AAEEC,MAAAA,UAAU,EAAE,CAAC,IAAD,EAAO,WAAP;AAFd,KADO,CAF6B;AAQtCE,IAAAA,KAAK,EAAE;AACLC,MAAAA,KAAK,EAAE,CADF;AAELK,MAAAA,KAAK,EAAE;AACL,SAACJ,cAAGE,IAAJ,GAAY,GAAEE,KAAM;AADf;AAFF;AAR+B,GAAjB,CAAvB;AAgBA,SAAOgC,QAAP;AACD;;AAEM,SAASI,cAAT,CAAwBJ,QAAxB,EAAkC;AACvC,SAAO9C,eAASmD,MAAT,CAAgBL,QAAhB,CAAP;AACD;;AAEM,SAASM,cAAT,CAAwBP,EAAxB,EAA4BC,QAA5B,EAAsC;AAC3C,SAAO9C,eAASqD,MAAT,CAAgBP,QAAhB,EAA0B;AAAEtC,IAAAA,KAAK,EAAE;AAAEqC,MAAAA;AAAF;AAAT,GAA1B,CAAP;AACD;;AAEM,SAASS,cAAT,CAAwBT,EAAxB,EAA4B;AACjC,SAAO7C,eAAS+C,QAAT,CAAkBF,EAAlB,EAAsBU,IAAtB,CAA2BC,GAAG,IAAIA,GAAG,CAACC,OAAJ,EAAlC,CAAP;AACD;;AAEM,eAAeC,YAAf,CAA4B5C,KAA5B,EAAmC6C,QAAnC,EAA6C;AAClD,QAAMjC,IAAI,GAAG,MAAM1B,eAASiD,OAAT,CAAiB;AAClCzC,IAAAA,KAAK,EAAE;AACLM,MAAAA;AADK;AAD2B,GAAjB,CAAnB;;AAMA,MAAI,CAACY,IAAL,EAAW;AACT,UAAM,IAAIkC,KAAJ,CAAU,wBAAV,CAAN;AACD,GAFD,MAEO;AACL,UAAMC,IAAI,GAAGnC,IAAI,CAACoC,GAAL,CAAS,UAAT,CAAb;;AACA,UAAMC,OAAO,GAAGC,kBAAOC,WAAP,CAAmBN,QAAnB,EAA6BE,IAA7B,CAAhB;;AACA,UAAMK,OAAO,GAAG,EAAE,GAAGxC,IAAI,CAACyC,MAAL;AAAL,KAAhB,CAHK,CAKL;;AACA,WAAOJ,OAAO,GACVK,sBAAIC,IAAJ,CAASH,OAAT,EAAkBvC,OAAO,CAACC,GAAR,CAAY0C,gBAA9B,EAAgD;AAAEC,MAAAA,SAAS,EAAE;AAAb,KAAhD,CADU,GAEV,IAFJ;AAGD;AACF","sourcesContent":["import { Op } from 'sequelize';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport nodemailer from 'nodemailer';\nimport Resource from './model';\n\nexport async function getAllResources(offset, limit, search) {\n  const resources = Resource.findAll({\n    order: [['id', 'DESC']],\n    offset,\n    limit,\n    include: [\n      {\n        association: Resource.Perfil,\n        attributes: ['id', 'descricao'],\n        as: 'perfil',\n      },\n    ],\n    where: {\n      ativo: 1,\n      [Op.or]: [\n        {\n          '$perfil.descricao$': { [Op.like]: `%${search}%` },\n        },\n        {\n          nome: { [Op.like]: `%${search}%` },\n        },\n        {\n          email: { [Op.like]: `%${search}%` },\n        },\n        {\n          sobrenome: { [Op.like]: `%${search}%` },\n        },\n        {\n          username: { [Op.like]: `%${search}%` },\n        },\n      ],\n    },\n  });\n\n  return resources;\n}\n\nexport async function sendEmail(email, novaSenha) {\n  const transporter = nodemailer.createTransport({\n    service: 'gmail', // smtp.gmail.com  //in place of service use host...\n    secure: false, // true\n    port: 25, // 465\n    auth: {\n      user: process.env.EMAIL_USER,\n      pass: process.env.EMAIL_PASSWORD,\n    },\n    tls: {\n      rejectUnauthorized: false,\n    },\n  });\n\n\n  const HelperOptions = {\n    from: '\"ICandy\" <georgefeitosajr12@gmail.com',\n    to: email,\n    subject: 'Nova senha',\n    text: `Aqui está sua nova senha ${novaSenha}`,\n  };\n\n\n  transporter.sendMail(HelperOptions, (error, info) => {\n    if (error) {\n      return console.log(error);\n    }\n    console.log('The message was sent!');\n    console.log(info);\n  });\n}\n\nexport async function getResource(id) {\n  const resource = await Resource.findByPk(id, {\n    include: [\n      {\n        association: Resource.Perfil,\n        attributes: ['id', 'descricao'],\n      },\n    ],\n  });\n\n  return resource;\n}\n\nexport async function getResourceEmail(email) {\n  const resource = await Resource.findOne({\n    order: [['id', 'DESC']],\n    include: [\n      {\n        association: Resource.Perfil,\n        attributes: ['id', 'descricao'],\n      },\n    ],\n    where: {\n      ativo: 1,\n      email: {\n        [Op.like]: `${email}`,\n      },\n    },\n  });\n\n  return resource;\n}\n\nexport function createResource(resource) {\n  return Resource.create(resource);\n}\n\nexport function updateResource(id, resource) {\n  return Resource.update(resource, { where: { id } });\n}\n\nexport function deleteResource(id) {\n  return Resource.findByPk(id).then(res => res.destroy());\n}\n\nexport async function authenticate(email, password) {\n  const user = await Resource.findOne({\n    where: {\n      email,\n    },\n  });\n\n  if (!user) {\n    throw new Error('Usuário não encontrado');\n  } else {\n    const hash = user.get('password');\n    const compare = bcrypt.compareSync(password, hash);\n    const payload = { ...user.toJSON() };\n\n    // token\n    return compare\n      ? jwt.sign(payload, process.env.TOKEN_SECRET_KEY, { expiresIn: '6h' })\n      : null;\n  }\n}\n"],"file":"service.js"}