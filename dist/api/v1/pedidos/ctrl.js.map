{"version":3,"sources":["../../../../src/api/v1/pedidos/ctrl.js"],"names":["router","get","req","res","next","offset","limit","s","query","resources","resourceService","getAllResources","json","value","error","id","params","resource","getResource","getResourceUser","post","console","log","body","longitude","troco","replace","payload","formas_pagamento_id","usuarios_id","user","status_pedido_id","observacao","createResource","itens","map","item","payloadPedidoProduto","pedidos_id","produtos_id","quantidade","qtd","produto","produtoService","qtdEstoque","Number","Error","updateResource","qtd_estoque","pedidoProdutoService","localizacoesPedidosService","pedido_id","latitude","put","delete","deleteResource"],"mappings":"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","sourcesContent":["import { Router } from 'express';\nimport * as resourceService from './service';\nimport * as pedidoProdutoService from '../pedidosProdutos/service';\nimport * as produtoService from '../produtos/service';\nimport * as localizacoesPedidosService from '../localizacoesPedidos/service';\n\nconst router = Router();\n\nrouter.get('/', async (req, res, next) => {\n  try {\n    const { offset = 0, limit = 10, s = '' } = req.query;\n    const resources = await resourceService.getAllResources(offset, limit, s);\n\n    return res.json({\n      value: resources,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nrouter.get('/:id', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n\n    const resource = await resourceService.getResource(id);\n\n    return res.json({\n      value: resource,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nrouter.get('/user/:id', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n\n    const resource = await resourceService.getResourceUser(id);\n\n    return res.json({\n      value: resource,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nrouter.post('/', async (req, res, next) => {\n  try {\n    console.log(req.body);\n    console.log(req.body.longitude);\n    req.body.troco = req.body.troco ? req.body.troco.replace(',', '.') : 0;\n    const payload = {\n      formas_pagamento_id: req.body.formas_pagamento_id,\n      usuarios_id: req.user.id,\n      status_pedido_id: 1,\n      observacao: req.body.observacao,\n      troco: req.body.troco,\n    };\n\n    let resource = await resourceService.createResource(payload);\n    resource = await resourceService.getResource(resource.id);\n\n    req.body.itens.map(async (item) => {\n      const payloadPedidoProduto = {\n        pedidos_id: resource.id,\n        produtos_id: item.id,\n        quantidade: item.qtd,\n      };\n\n      const produto = await produtoService.getResource(item.id);\n      const qtdEstoque = produto.get('qtd_estoque') - Number(item.qtd);\n      if (qtdEstoque <= 0) {\n        throw new Error(\n          `O produto ${produto.get('nome')} não está mais disponível`,\n        );\n      }\n      await produtoService.updateResource(item.id, { qtd_estoque: qtdEstoque });\n\n      await pedidoProdutoService.createResource(payloadPedidoProduto);\n    });\n\n    await localizacoesPedidosService.createResource({\n      pedido_id: resource.id,\n      longitude: req.body.longitude,\n      latitude: req.body.latitude,\n    });\n\n    return res.json({\n      value: resource,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nrouter.put('/:id', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n\n    let resource = await resourceService.updateResource(id, req.body);\n    resource = await resourceService.getResource(id);\n\n    return res.json({\n      value: resource,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nrouter.delete('/:id', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n    await resourceService.deleteResource(id);\n\n    return res.json({\n      value: id,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nexport default router;\n"],"file":"ctrl.js"}