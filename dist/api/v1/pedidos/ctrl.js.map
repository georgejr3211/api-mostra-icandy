{"version":3,"sources":["../../../../src/api/v1/pedidos/ctrl.js"],"names":["router","get","req","res","next","offset","limit","s","query","resources","resourceService","getAllResources","json","value","error","id","params","resource","getResource","getResourceUser","post","body","troco","replace","payload","formas_pagamento_id","usuarios_id","user","status_pedido_id","observacao","produtosForaEstoque","verificaEstoque","itens","map","item","length","filter","prod","find","pItem","qtdEstoque","qtd_estoque","Number","qtd","status","createResource","payloadPedidoProduto","pedidos_id","produtos_id","quantidade","produto","produtoService","updateResource","pedidoProdutoService","console","log","localizacoesPedidosService","pedido_id","metodo_entrega","longitude","latitude","put","delete","deleteResource"],"mappings":"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","sourcesContent":["import { Router } from 'express';\nimport * as resourceService from './service';\nimport * as pedidoProdutoService from '../pedidosProdutos/service';\nimport * as produtoService from '../produtos/service';\nimport * as localizacoesPedidosService from '../localizacoesPedidos/service';\n\nconst router = Router();\n\nrouter.get('/', async (req, res, next) => {\n  try {\n    const { offset = 0, limit = 10, s = '' } = req.query;\n    const resources = await resourceService.getAllResources(offset, limit, s);\n\n    return res.json({\n      value: resources,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nrouter.get('/:id', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n\n    const resource = await resourceService.getResource(id);\n\n    return res.json({\n      value: resource,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nrouter.get('/user/:id', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n\n    const resource = await resourceService.getResourceUser(id);\n\n    return res.json({\n      value: resource,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nrouter.post('/', async (req, res, next) => {\n  try {\n    // console.log(req.body);\n    // console.log(req.body.longitude);\n    req.body.troco = req.body.troco ? req.body.troco.replace(',', '.') : 0;\n    const payload = {\n      formas_pagamento_id: req.body.formas_pagamento_id,\n      usuarios_id: req.user.id,\n      status_pedido_id: 1,\n      observacao: req.body.observacao,\n      troco: req.body.troco,\n    };\n\n    // busca os produtos que o usuÃ¡rio pediu\n    let produtosForaEstoque = await resourceService.verificaEstoque(\n      req.body.itens.map(item => item.id),\n    );\n\n    if (produtosForaEstoque.length) {\n      // verifica se os produtos estao fora de estoque\n      produtosForaEstoque = produtosForaEstoque.filter((prod) => {\n        const item = req.body.itens.find(pItem => pItem.id === prod.id);\n        const qtdEstoque = prod.qtd_estoque - Number(item.qtd);\n        if (qtdEstoque < 0) {\n          return prod;\n        }\n      });\n\n      if (produtosForaEstoque.length !== 0) {\n        return res.status(400).json(produtosForaEstoque);\n      }\n    }\n\n    let resource = await resourceService.createResource(payload);\n    resource = await resourceService.getResource(resource.id);\n    req.body.itens.map(async (item) => {\n      const payloadPedidoProduto = {\n        pedidos_id: resource.id,\n        produtos_id: item.id,\n        quantidade: item.qtd,\n      };\n\n      const produto = await produtoService.getResource(item.id);\n      const qtdEstoque = produto.get('qtd_estoque') - Number(item.qtd);\n\n      await produtoService.updateResource(item.id, {\n        qtd_estoque: qtdEstoque,\n      });\n\n      await pedidoProdutoService.createResource(payloadPedidoProduto);\n    });\n\n    // await localizacoesPedidosService.createResource({\n    //   pedido_id: resource.id,\n    //   longitude: req.body.longitude,\n    //   latitude: req.body.latitude,\n    // });\n\n    console.log('req', req.body);\n\n    await localizacoesPedidosService.createResource({\n      pedido_id: resource.id,\n      metodo_entrega: req.body.metodo_entrega,\n      longitude: req.body.longitude,\n      latitude: req.body.latitude,\n    });\n\n    return res.json({\n      value: resource,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nrouter.put('/:id', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n\n    let resource = await resourceService.updateResource(id, req.body);\n    resource = await resourceService.getResource(id);\n\n    return res.json({\n      value: resource,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nrouter.delete('/:id', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n    await resourceService.deleteResource(id);\n\n    return res.json({\n      value: id,\n    });\n  } catch (error) {\n    return next(error);\n  }\n});\n\nexport default router;\n"],"file":"ctrl.js"}